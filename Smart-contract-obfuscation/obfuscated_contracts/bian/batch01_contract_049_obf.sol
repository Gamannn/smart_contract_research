pragma solidity ^0.4.18;contract ERC20 { function Ox44979037d1db94fb88cad58450caafb514f3827c(address Oxd2f9ecf2180be25cd8665fe9e9a73bd84ef72480, uint256 Oxdc30bf41950e24cf8d0f5da6ef58ba74cf319bb7) public returns (bool Ox283abf9c7098e0e71a51bc4afedb2dfea6d924ad); function transferFrom(address _from, address Oxd2f9ecf2180be25cd8665fe9e9a73bd84ef72480, uint256 Oxdc30bf41950e24cf8d0f5da6ef58ba74cf319bb7) public returns (bool Ox283abf9c7098e0e71a51bc4afedb2dfea6d924ad);}library SafeMath { function mul(uint256 a, uint256 b) internal pure returns (uint256) { if (a == 0) { return 0; } uint256 c = a * b; require(c / a == b); return c; } function div(uint256 a, uint256 b) internal pure returns (uint256) { uint256 c = a / b; return c; } function sub(uint256 a, uint256 b) internal pure returns (uint256) { require(b <= a); return a - b; } function add(uint256 a, uint256 b) internal pure returns (uint256) { uint256 c = a + b; require(c >= a); return c; } function min(uint a, uint b) internal pure returns (uint) { if (a >= b) return b; return a; } function max(uint a, uint b) internal pure returns (uint) { if (a >= b) return a; return b; }}contract DSAuthority { function canCall( address src, address dst, bytes4 sig ) public view returns (bool);}contract DSAuthEvents { event LogSetAuthority (address indexed authority); event LogSetOwner (address indexed Ox747a042b6d9f2fc47cd68a3dba2129d9da1f9cd9);}contract DSAuth is DSAuthEvents { DSAuthority public authority; constructor() public { Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.Ox747a042b6d9f2fc47cd68a3dba2129d9da1f9cd9 = msg.sender; emit LogSetOwner(msg.sender); } function Oxd51782a6b86d18c15214eb57cb5f02118339daeb(address owner_) public auth { Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.Ox747a042b6d9f2fc47cd68a3dba2129d9da1f9cd9 = owner_; emit LogSetOwner(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.Ox747a042b6d9f2fc47cd68a3dba2129d9da1f9cd9); } function setAuthority(DSAuthority authority_) public auth { authority = authority_; emit LogSetAuthority(authority); } modifier auth { require(isAuthorized(msg.sender, msg.sig)); _; } function isAuthorized(address src, bytes4 sig) internal view returns (bool) { if (src == address(this)) { return true; } else if (src == Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.Ox747a042b6d9f2fc47cd68a3dba2129d9da1f9cd9) { return true; } else if (authority == DSAuthority(0)) { return false; } else { return authority.canCall(src, this, sig); } }}contract Exchange is DSAuth { using SafeMath for uint; ERC20 public daiToken; mapping(address => uint) public dai; mapping(address => uint) public eth; mapping(address => uint) public totalEth; mapping(address => uint) public totalDai; mapping(bytes32 => mapping(address => uint)) public callsOwned; mapping(bytes32 => mapping(address => uint)) public putsOwned; mapping(bytes32 => mapping(address => uint)) public callsSold; mapping(bytes32 => mapping(address => uint)) public putsSold; mapping(bytes32 => uint) public callsAssigned; mapping(bytes32 => uint) public putsAssigned; mapping(bytes32 => uint) public callsExercised; mapping(bytes32 => uint) public putsExercised; mapping(address => mapping(bytes32 => bool)) public cancelled; mapping(address => mapping(bytes32 => uint)) public filled; mapping(address => uint) public feeRebates; mapping(bytes32 => bool) public claimedFeeRebate; constructor(address daiAddress) public { require(daiAddress != 0x0); daiToken = ERC20(daiAddress); } function() public payable { revert(); } event Deposit(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); event Withdraw(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address to); event DepositDai(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); event WithdrawDai(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address to); function deposit() public payable { _addEth(msg.value, msg.sender); emit Deposit(msg.sender, msg.value); } function depositDai(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) public { require(daiToken.transferFrom(msg.sender, this, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6)); _addDai(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, msg.sender); emit DepositDai(msg.sender, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } function withdraw(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address to) public { require(to != 0x0); _subEth(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, msg.sender); to.Ox44979037d1db94fb88cad58450caafb514f3827c(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit Withdraw(msg.sender, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, to); } function withdrawDai(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address to) public { require(to != 0x0); _subDai(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, msg.sender); daiToken.Ox44979037d1db94fb88cad58450caafb514f3827c(to, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit WithdrawDai(msg.sender, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, to); } function depositDaiFor(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address Oxf84cbc7de00d952ac8879a356382e4d4479661d7) public { require(Oxf84cbc7de00d952ac8879a356382e4d4479661d7 != 0x0); require(daiToken.transferFrom(msg.sender, this, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6)); _addDai(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, Oxf84cbc7de00d952ac8879a356382e4d4479661d7); emit DepositDai(Oxf84cbc7de00d952ac8879a356382e4d4479661d7, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } function _addEth(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address Oxf84cbc7de00d952ac8879a356382e4d4479661d7) private { eth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = eth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); totalEth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = totalEth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } function _subEth(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address Oxf84cbc7de00d952ac8879a356382e4d4479661d7) private { eth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = eth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); totalEth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = totalEth[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } function _addDai(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address Oxf84cbc7de00d952ac8879a356382e4d4479661d7) private { dai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = dai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); totalDai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = totalDai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } function _subDai(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, address Oxf84cbc7de00d952ac8879a356382e4d4479661d7) private { dai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = dai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); totalDai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7] = totalDai[Oxf84cbc7de00d952ac8879a356382e4d4479661d7].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } function setFeeSchedule( uint _flatFee, uint _contractFee, uint _exerciseFee, uint _settlementFee ) public auth { Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.flatFee = _flatFee; Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.contractFee = _contractFee; Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.exerciseFee = _exerciseFee; Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.settlementFee = _settlementFee; require(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.contractFee < 5 ether); require(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.flatFee < 6.95 ether); require(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.exerciseFee < 20 ether); require(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.settlementFee < 20 ether); } function withdrawFees(address to) public auth { require(to != 0x0); uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6 = Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.feesCollected.sub(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.feesWithdrawn); Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.feesWithdrawn = Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.feesCollected; require(daiToken.Ox44979037d1db94fb88cad58450caafb514f3827c(to, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6)); } modifier hasFee(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { _; _collectFee(msg.sender, calculateFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6)); } enum Action { BuyCallToOpen, BuyCallToClose, SellCallToOpen, SellCallToClose, BuyPutToOpen, BuyPutToClose, SellPutToOpen, SellPutToClose } event CancelOrder(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, bytes32 h); function cancelOrder(bytes32 h) public { cancelled[msg.sender][h] = true; emit CancelOrder(msg.sender, h); } function callBtoWithSto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellCallToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callBtoWithStc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellCallToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callBtcWithSto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellCallToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callBtcWithStc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellCallToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callStoWithBto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyCallToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callStoWithBtc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyCallToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callStcWithBto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyCallToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyCallToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function callStcWithBtc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyCallToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyCallToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } event BuyCallToOpen(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); event SellCallToOpen(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); event BuyCallToClose(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); event SellCallToClose(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); function _buyCallToOpen(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address buyer) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); _subDai(premium, buyer); callsOwned[series][buyer] = callsOwned[series][buyer].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit BuyCallToOpen(buyer, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } function _buyCallToClose(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address buyer) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); _subDai(premium, buyer); eth[buyer] = eth[buyer].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); callsSold[series][buyer] = callsSold[series][buyer].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit BuyCallToClose(buyer, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } function _sellCallToOpen(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address seller) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); _addDai(premium, seller); eth[seller] = eth[seller].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); callsSold[series][seller] = callsSold[series][seller].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit SellCallToOpen(seller, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } function _sellCallToClose(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address seller) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); _addDai(premium, seller); callsOwned[series][seller] = callsOwned[series][seller].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit SellCallToClose(seller, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } event ExerciseCall(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint strike); function exerciseCall( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint strike ) public { require(now < expiration, "Expired"); require(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6 % 1 finney == 0, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.precisionError); uint cost = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(strike).div(1 ether); bytes32 series = keccak256(expiration, strike); require(callsOwned[series][msg.sender] > 0); callsOwned[series][msg.sender] = callsOwned[series][msg.sender].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); callsExercised[series] = callsExercised[series].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); _collectFee(msg.sender, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.exerciseFee); _subDai(cost, msg.sender); _addEth(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, msg.sender); emit ExerciseCall(msg.sender, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, strike); } event AssignCall(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint strike); event SettleCall(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint expiration, uint strike); function settleCall(uint expiration, uint strike, address writer) public { require(msg.sender == writer || isAuthorized(msg.sender, msg.sig), "Unauthorized"); require(now > expiration, "Expired"); bytes32 series = keccak256(expiration, strike); require(callsSold[series][writer] > 0); if (callsAssigned[series] < callsExercised[series]) { uint maximum = callsSold[series][writer]; uint needed = callsExercised[series].sub(callsAssigned[series]); uint assignment = needed.min(maximum); totalEth[writer] = totalEth[writer].sub(assignment); callsAssigned[series] = callsAssigned[series].add(assignment); callsSold[series][writer] = callsSold[series][writer].sub(assignment); uint value = strike.mul(assignment).div(1 ether); _addDai(value, writer); emit AssignCall(msg.sender, assignment, expiration, strike); } _collectFee(writer, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.settlementFee); eth[writer] = eth[writer].add(callsSold[series][writer]); callsSold[series][writer] = 0; emit SettleCall(writer, expiration, strike); } function putBtoWithSto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellPutToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putBtoWithStc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellPutToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putBtcWithSto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellPutToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putBtcWithStc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.SellPutToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _buyPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _sellPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putStoWithBto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyPutToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putStoWithBtc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyPutToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putStcWithBto( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyPutToOpen, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyPutToOpen(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } function putStcWithBtc( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 nonce, uint price, uint size, uint strike, uint validUntil, bytes32 r, bytes32 s, uint8 v ) public hasFee(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) { bytes32 h = keccak256(Action.BuyPutToClose, expiration, nonce, price, size, strike, validUntil, this); address maker = _getMaker(h, v, r, s); _validateOrder(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, h, maker, price, validUntil, size, strike); _sellPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, msg.sender); _buyPutToClose(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike, maker); } event BuyPutToOpen(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); event SellPutToOpen(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); event BuyPutToClose(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); event SellPutToClose(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike); function _buyPutToOpen(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address buyer) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); _subDai(premium, buyer); putsOwned[series][buyer] = putsOwned[series][buyer].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit BuyPutToOpen(buyer, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } function _buyPutToClose(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address buyer) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); dai[buyer] = dai[buyer].add(strike.mul(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6).div(1 ether)); _subDai(premium, buyer); putsSold[series][buyer] = putsSold[series][buyer].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit BuyPutToClose(buyer, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } function _sellPutToOpen(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address seller) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); uint cost = strike.mul(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6).div(1 ether); _addDai(premium, seller); dai[seller] = dai[seller].sub(cost); putsSold[series][seller] = putsSold[series][seller].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit SellPutToOpen(seller, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } function _sellPutToClose(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint price, uint strike, address seller) private { bytes32 series = keccak256(expiration, strike); uint premium = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(price).div(1 ether); _addDai(premium, seller); putsOwned[series][seller] = putsOwned[series][seller].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit SellPutToClose(seller, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, price, strike); } event ExercisePut(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint strike); function exercisePut( uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint strike ) public { require(now < expiration, "Expired"); require(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6 % 1 finney == 0, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.precisionError); uint yield = Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(strike).div(1 ether); bytes32 series = keccak256(expiration, strike); require(putsOwned[series][msg.sender] > 0); putsOwned[series][msg.sender] = putsOwned[series][msg.sender].sub(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); putsExercised[series] = putsExercised[series].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); _subEth(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, msg.sender); _addDai(yield, msg.sender); _collectFee(msg.sender, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.exerciseFee); emit ExercisePut(msg.sender, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, expiration, strike); } event AssignPut(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, uint strike); event SettlePut(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint expiration, uint strike); function settlePut(uint expiration, uint strike, address writer) public { require(msg.sender == writer || isAuthorized(msg.sender, msg.sig), "Unauthorized"); require(now > expiration, "Expired"); bytes32 series = keccak256(expiration, strike); require(putsSold[series][writer] > 0); if (putsAssigned[series] < putsExercised[series]) { uint maximum = putsSold[series][writer]; uint needed = putsExercised[series].sub(putsAssigned[series]); uint assignment = maximum.min(needed); totalDai[writer] = totalDai[writer].sub(assignment.mul(strike).div(1 ether)); putsSold[series][writer] = putsSold[series][writer].sub(assignment); putsAssigned[series] = putsAssigned[series].add(assignment); _addEth(assignment, writer); emit AssignPut(writer, assignment, expiration, strike); } uint yield = putsSold[series][writer].mul(strike).div(1 ether); _collectFee(writer, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.settlementFee); dai[writer] = dai[writer].add(yield); putsSold[series][writer] = 0; emit SettlePut(writer, expiration, strike); } function calculateFee(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) public view returns (uint) { return Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6.mul(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.contractFee).div(1 ether).add(Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.flatFee); } function claimFeeRebate(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, bytes32 nonce, bytes32 r, bytes32 s, uint8 v) public { bytes32 h = keccak256(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, nonce, msg.sender); h = keccak256("\x19Ethereum Signed Message:\n32", h); address signer = ecrecover(h, v, r, s); require(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6 <= 1000); require(isAuthorized(signer, msg.sig)); require(claimedFeeRebate[nonce] == false); feeRebates[msg.sender] = feeRebates[msg.sender].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); claimedFeeRebate[nonce] = true; } event TakeOrder(address indexed Oxf84cbc7de00d952ac8879a356382e4d4479661d7, address maker, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, bytes32 h); function _validateOrder(uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, uint expiration, bytes32 h, address maker, uint price, uint validUntil, uint size, uint strike) private { require(strike % 1 ether == 0, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.precisionError); require(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6 % 1 finney == 0, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.precisionError); require(price % 1 finney == 0, Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.precisionError); require(expiration % 86400 == 0, "Expiration"); require(cancelled[maker][h] == false, "Cancelled"); require(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6 <= size.sub(filled[maker][h]), "Filled"); require(now < validUntil, "OrderExpired"); require(now < expiration, "Expired"); filled[maker][h] = filled[maker][h].add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); emit TakeOrder(msg.sender, maker, Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, h); } function _collectFee(address Oxf84cbc7de00d952ac8879a356382e4d4479661d7, uint Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6) private { if (feeRebates[msg.sender] > 0) { feeRebates[msg.sender] = feeRebates[msg.sender].sub(1); } else { _subDai(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6, Oxf84cbc7de00d952ac8879a356382e4d4479661d7); Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.feesCollected = Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2.feesCollected.add(Ox8a7e5d0c49c0312f4cb575b3d4fe79aeaa1bd8d6); } } function _getMaker(bytes32 h, uint8 v, bytes32 r, bytes32 s) public pure returns (address) { return ecrecover(keccak256("\x19Ethereum Signed Message:\n32", h), v, r, s); }struct scalar2Vector {string precisionError;uint256 feesWithdrawn;uint256 feesCollected;uint256 settlementFee;uint256 exerciseFee;uint256 contractFee;uint256 flatFee;address Ox747a042b6d9f2fc47cd68a3dba2129d9da1f9cd9;}scalar2Vector Oxe8ee67a4304e7d9dc6ee8ed45d4105de5d2be1a2 = scalar2Vector( "Precision", 0, 0, 20 ether, 20 ether, 1 ether, 7 ether, address(0));}